(()=>{"use strict";window.util={getArrOfTextBeforeDash:function(e){const t=[],n=[];for(let o=0;o<e.length;o++)for(let r=e[o].length-1;r>=0;r--){if("-"===e[o][r]){t.reverse(),n.push(t.join("")),n.splice(0,t.length);break}t.push(e[o][r])}return n},getArrClassNameHtml:function(e){const t=[];return e.forEach((e=>{t.push(e.className)})),t},getLastItemOfString:function(e){const t=[];for(let n=e.length-1;n>0&&" "!==e[n];n--)t.push(e[n]);return t.join("")},getFirstItemOfString:function(e){const t=[];for(let n=0;n<e.length&&","!==e[n];n++)t.push(e[n]);return t.join("")},comparisonArrsAndAddClassNameHidden:function(e,t,n){for(let o=0;o<e.length;o++)for(let r=0;r<t.length;r++)n[r].classList.add("hidden"),e[o]===t[r]&&(n[r].textContent=e[o]),n[r].textContent&&n[r].classList.remove("hidden")}},window.backend={load:function(e,t){const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?e(n.response):t(`Статус ответа:  ${n.status} ${n.statusText}`)})),n.addEventListener("error",(function(){t("Запрос не удался")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},save:function(e,t,n){const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){200===o.status?t():n()})),o.addEventListener("timeout",(function(){n()})),o.addEventListener("error",(function(){n()})),o.timeout=1e4,o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}},(()=>{const e="\n1 комната — «для 1 гостя»;\n2 комнаты — «для 2 гостей» или «для 1 гостя»;\n3 комнаты — «для 3 гостей», «для 2 гостей» или «для 1 гостя»;\n100 комнат — «не для гостей».",t=document.querySelector("#capacity"),n=t.querySelectorAll("option");n.forEach((e=>{e.removeAttribute("disabled")})),document.querySelector("#title").setAttribute("minlength",30);const o=document.querySelector("#price");o.setAttribute("max",1e6);const r=document.querySelector("#type"),i=function(e){const t=[];return e.forEach((e=>{t.push(e.value)})),t}(r.querySelectorAll("option")),c=[0,1e3,5e3,1e4],d=function(){const e=r.value;for(let t=0;t<i.length;t++)e===i[t]&&(o.setAttribute("placeholder","от "+c[t]),o.setAttribute("min",""+c[t]))};r.addEventListener("change",d),o.setAttribute("required","required"),o.setAttribute("type","number"),o.setAttribute("max","1000000"),document.querySelector("#avatar").setAttribute("accept","image/*"),document.querySelector("#images").setAttribute("accept","image/*");const a=document.querySelector("#timein"),s=a.querySelectorAll("option"),u=document.querySelector("#timeout"),l=u.querySelectorAll("option"),f=document.querySelector(".map__pins"),p=document.querySelector(".ad-form");p.addEventListener("submit",(function(e){e.preventDefault(),window.backend.save(new FormData(p),w,S)}));const m=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),w=function(){f.appendChild(m),document.addEventListener("keydown",v),document.addEventListener("click",h),p.reset(),window.main.addAdFormDisabled(p),window.main.addMapFaded(window.card.map),y(),window.main.mapPinMain.addEventListener("mousedown",window.main.onMapPinMainMousedown)},y=function(){const e=f.querySelectorAll("button");for(let t=0;t<e.length;t++)e[t].classList.contains("map__pin--main")||e[t].remove()},v=function(e){27===e.keyCode&&(m.remove(),document.removeEventListener("keydown",v),document.removeEventListener("click",h))},h=function(){m.remove(),document.removeEventListener("click",h),document.removeEventListener("keydown",v)},_=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);let L;const S=function(){document.querySelector("main").appendChild(_),L=document.querySelector(".error__button"),document.addEventListener("click",q),document.addEventListener("keydown",g),L.addEventListener("click",E)},q=function(){_.remove(),document.removeEventListener("click",q),document.removeEventListener("keydown",g),L.removeEventListener("click",E)},g=function(e){27===e.keyCode&&(_.remove(),document.removeEventListener("keydown",g),document.removeEventListener("click",q),L.removeEventListener("click",E))},E=function(){_.remove(),L.removeEventListener("click",E),document.removeEventListener("keydown",g),document.removeEventListener("click",q)},k=function(){p.reset(),C.removeEventListener("click",k),C.removeEventListener("keydown",A)},A=function(e){13===e.keyCode&&(p.reset(),C.removeEventListener("click",k),C.removeEventListener("keydown",A))},C=document.querySelector(".ad-form__reset");C.addEventListener("click",k),C.addEventListener("keydown",A),window.form={setTimeinAndTimeout:function(){a.addEventListener("change",(function(){for(let e=0;e<s.length;e++)s[e].value===a.value&&(u.value=a[e].value)})),u.addEventListener("change",(function(){for(let e=0;e<l.length;e++)l[e].value===u.value&&(a.value=u[e].value)}))},capacityOptions:n,capacity:t,checkRoomAndGuest:function(){const n=document.querySelector("#room_number");let o=n.value,r=t.value,i=o-1;const c=[["1"],["1","2"],["1","2","3"],["0"]];!1===(c[i].includes(o)&&c[i].includes(r))?n.setCustomValidity(e):n.setCustomValidity(""),n.addEventListener("change",(function(){const t=n.value;o=t,o>3?(o="0",i=c.length-1):i=o-1,!1===(c[i].includes(o)&&c[i].includes(r))?n.setCustomValidity(e):n.setCustomValidity("")})),t.addEventListener("change",(function(){const d=t.value;r=d,!1===(c[i].includes(o)&&c[i].includes(r))?n.setCustomValidity(e):n.setCustomValidity("")}))},onTypeChange:d}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__filters-container"),n=document.querySelector(".map");window.card={createCard:function(t){const n=e.cloneNode(!0);t.offer.title?n.querySelector(".popup__title").textContent=t.offer.title:n.querySelector(".popup__title").classList.add("hidden"),t.offer.address[0]&&t.offer.address[1]?n.querySelector(".popup__text--address").textContent=`${window.util.getFirstItemOfString(t.offer.address)} Tōkyō-to, Chiyoda-ku, Ichibanchō, ${window.util.getLastItemOfString(t.offer.address)}`:n.querySelector(".popup__text--address").classList.add("hidden"),t.offer.price?n.querySelector(".popup__text--price").textContent=t.offer.price:n.querySelector(".popup__text--price").classList.add("hidden"),t.offer.type?n.querySelector(".popup__type").textContent=t.offer.type:n.querySelector(".popup__type").classList.add("hidden"),t.offer.rooms&&t.offer.guests?n.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнатa(ы) для ${t.offer.guests} гостя(ей)`:n.querySelector(".popup__text--capacity").classList.add("hidden"),t.offer.checkin&&t.offer.checkout?n.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`:n.querySelector(".popup__text--time").classList.add("hidden");const o=n.querySelector(".popup__features").querySelectorAll("li"),r=window.util.getArrClassNameHtml(o).slice(),i=window.util.getArrOfTextBeforeDash(r);window.util.comparisonArrsAndAddClassNameHidden(t.offer.features,i,o),t.offer.description?n.querySelector(".popup__description").textContent=""+t.offer.description:n.querySelector(".popup__description").classList.add("hidden");const c=n.querySelector(".popup__photos"),d=n.querySelector(".popup__photos").querySelector("img");if(t.offer.photos){for(let e=0;e<t.offer.photos.length;e++){const n=d.cloneNode();n.src=t.offer.photos[e],n.textContent="clone",c.appendChild(n)}c.removeChild(d)}else c.classList.add("hidden");return t.author.avatar?n.querySelector(".popup__avatar").src=t.author.avatar:n.querySelector(".popup__avatar").classList.add("hidden"),n},mapFiltersContainer:t,card:e,renderCard:function(e,t){n.insertBefore(e,t)},map:n}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={pin:e,MAX_PIN:5,createPin:function(t){const n=e.cloneNode(!0);return n.querySelector("img").src=t.author.avatar,n.querySelector("img").alt=t.offer.title,n.style.left=t.location.x+"px",n.style.top=t.location.y+"px",n}}})(),(()=>{window.card.map.addEventListener("click",(function(e){let t=e.target;if("IMG"===t.tagName&&(t=t.parentNode),t.classList.contains("map__pin")&&!t.classList.contains("map__pin--main"))if(window.card.map.querySelector(".map__card"))window.card.map.removeChild(window.card.map.querySelector(".map__card"));else{const n=function(n){window.card.renderCard(window.card.createCard(n[t.dataset.index]),window.card.mapFiltersContainer);const o=document.querySelector(".popup__close"),r=window.card.map.querySelector(".map__card"),i=function(){window.card.map.removeChild(r)};o.addEventListener("click",(function(){i()})),o.addEventListener("keydown",(function(){13===e.target.code&&i()}))};window.backend.load(n,window.pin.onError)}})),window.card.map.addEventListener("keydown",(function(e){"Escape"===e.key&&window.card.map.querySelector(".map__card")&&window.card.map.removeChild(window.card.map.querySelector(".map__card"))}));const e=document.querySelector(".map__pin--main"),t=document.querySelectorAll("fieldset"),n=document.querySelector(".map__filters"),o=function(e){e.classList.add("map--faded")};o(window.card.map),t.forEach((e=>{e.setAttribute("disabled","true")}));const r=function(e){e.classList.remove("ad-form--disabled")},i=function(){t.forEach((e=>{e.removeAttribute("disabled")}))},c=document.querySelector(".ad-form"),d=function(t){1===t.which&&window.card.map.classList.remove("map--faded"),r(c),i(),window.startPins.renderPin(),window.form.checkRoomAndGuest(),window.form.onTypeChange(),window.form.setTimeinAndTimeout(),e.removeEventListener("mousedown",d),e.removeEventListener("keydown",a)};window.card.map.classList.contains("map--faded")&&e.addEventListener("mousedown",d);const a=function(t){"Enter"===t.code&&window.card.map.classList.remove("map--faded"),r(c),i(),window.startPins.renderPin(),window.form.checkRoomAndGuest(),window.form.onTypeChange(),window.form.setTimeinAndTimeout(),e.removeEventListener("keydown",a),e.removeEventListener("mousedown",d)};window.card.map.classList.contains("map--faded")&&e.addEventListener("keydown",a),window.main={addMapFaded:o,addAdFormDisabled:function(e){e.classList.add("ad-form--disabled")},mapFilter:n,mapPinMain:e,onMapPinMainMousedown:d}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address"),n=document.querySelector(".map__pins"),o=e.offsetHeight+22;function r(e,t,n){e.setAttribute("value",`${t}, ${n}`)}e.addEventListener("mousedown",(function(i){i.preventDefault();let c={x:i.clientX,y:i.clientY},d=Math.round(e.offsetLeft+e.offsetWidth/2),a=Math.round(e.offsetTop+o);function s(i){i.preventDefault();const s=c.x-i.clientX,u=c.y-i.clientY,l=d-s,f=a-u;d=Math.round(e.offsetLeft+e.offsetWidth/2),a=Math.round(e.offsetTop+o),c={x:i.clientX,y:i.clientY},e.style.left=e.offsetLeft-s+"px",e.style.top=e.offsetTop-u+"px",r(t,l,f),l<=0&&(e.style.left=-e.offsetWidth/2+"px",r(t,0,f)),l>=n.offsetWidth&&(e.style.left=n.offsetWidth-e.offsetWidth/2+"px",r(t,n.offsetWidth,f)),f<=130&&(e.style.top=130-o+"px",r(t,l,130)),f>=760&&(e.style.top=760-o+"px",r(t,l,760))}t.setAttribute("value",`${d}, ${a}`),document.addEventListener("mousemove",s),document.addEventListener("mouseup",(function e(t){t.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",e)}))}))})(),(()=>{const e="any",t=["wifi","dishwasher","parking","washer","elevator","conditioner"],n=1e4,o=5e4,r="any",i="middle",c="high",d=function(){const e=window.startPins.mapPinsHtml.querySelectorAll(".map__pin");for(let t=0;t<e.length;t++)e[t].classList.contains("map__pin--main")||e[t].remove()};let a;window.backend.load((function(s){const u=s;let l="any",f="any",p="any",m="any";const w=document.querySelector("#housing-type");w.addEventListener("change",(function(){d(),l=w.value}));const y=document.querySelector("#housing-price");y.addEventListener("change",(function(){d(),f=y.value}));const v=document.querySelector("#housing-rooms");v.addEventListener("change",(function(){d(),p=v.value}));const h=document.querySelector("#housing-guests");h.addEventListener("change",(function(){d(),m=h.value})),document.querySelector(".map__filters").addEventListener("change",(function(){window.card.map.querySelector(".map__card")&&document.querySelector(".map__card").remove();const s=u.filter((function(t){return t.offer.type===l?t.offer.type===l:l===e&&t.offer.type})),w=u.filter((function(e){return f===i&&e.offer.price>=n&&e.offer.price<o?e.offer.price>=n&&e.offer.price<o:"low"===f?e.offer.price<1e4:f===c?e.offer.price>=5e4:f===r&&e.offer.price})),y=u.filter((function(t){if(p!==e){const e=parseInt(p,10);return t.offer.rooms===e}return t.offer.rooms})),v=u.filter((function(t){if(m!==e){const e=parseInt(m,10);return t.offer.guests===e}return t.offer.guests})),h=s.concat(w).concat(y).concat(v),_=h.filter((function(e,t){return h.indexOf(e)===t})).filter((function(t){if(l!==e&&t.offer.type!==l)return!1;if(f===i){if(f!==r&&t.offer.price<n)return!1;if(f!==r&&t.offer.price>=o)return!1}return!("low"===f&&f!==r&&t.offer.price>1e4||f===c&&f!==r&&t.offer.price<=5e4||p!==e&&t.offer.rooms!==parseInt(p,10)||m!==e&&t.offer.guests!==parseInt(m,10))})),L=document.querySelectorAll(".map__checkbox"),S=[];for(let e=0;e<L.length;e++)L[e].checked&&S.push(t[e]);const q=_.filter((function(e){let t=0;for(let n=0;n<S.length;n++)for(let o=0;o<e.offer.features.length;o++)S[n]===e.offer.features[o]&&t++;return t===S.length}));a&&clearTimeout(a),a=setTimeout((function(){!function(e){if(d(),e.length<window.pin.MAX_PIN)for(let t=0;t<e.length;t++){const n=window.pin.createPin(e[t]);n.setAttribute("data-index",t),window.startPins.fragment.appendChild(n),window.startPins.renderPin()}else if(e.length>window.pin.MAX_PIN)for(let t=0;t<window.pin.MAX_PIN;t++){const n=window.pin.createPin(e[t]);n.setAttribute("data-index",t),window.startPins.fragment.appendChild(n),window.startPins.renderPin()}}(q)}),500)}))}),window.error.onError)})(),(()=>{const e=document.createDocumentFragment();let t=[];window.backend.load((function(n){t=n;for(let t=0;t<window.pin.MAX_PIN;t++){const o=window.pin.createPin(n[t]);o.setAttribute("data-index",t),e.appendChild(o)}}),window.error.onError);const n=document.querySelector(".map__pins");window.startPins={renderPin:function(){n.appendChild(e)},dataFlats:t,fragment:e,mapPinsHtml:n}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=function(e,t,n){e.addEventListener("change",(()=>{const o=e.files[0],r=o.name.toLowerCase();if(n.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(()=>{t.src=e.result})),e.readAsDataURL(o)}}))};t(document.querySelector(".ad-form__field input[type=file]"),document.querySelector(".ad-form-header__preview"),e),t(document.querySelector(".ad-form__upload input[type=file]"),document.querySelector(".ad-form__photo"),e)})()})();