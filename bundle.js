(()=>{"use strict";window.util={getArrOfTextBeforeDash:function(e){const t=[],n=[];for(let o=0;o<e.length;o++)for(let r=e[o].length-1;r>=0;r--){if("-"===e[o][r]){t.reverse(),n.push(t.join("")),n.splice(0,t.length);break}t.push(e[o][r])}return n},getArrClassNameHtml:function(e){const t=[];return e.forEach((e=>{t.push(e.className)})),t},getLastItemOfString:function(e){const t=[];for(let n=e.length-1;n>0&&" "!==e[n];n--)t.push(e[n]);return t.join("")},getFirstItemOfString:function(e){const t=[];for(let n=0;n<e.length&&","!==e[n];n++)t.push(e[n]);return t.join("")},comparisonArrsAndAddClassNameHidden:function(e,t,n){for(let o=0;o<e.length;o++)for(let r=0;r<t.length;r++)n[r].classList.add("hidden"),e[o]===t[r]&&(n[r].textContent=e[o]),n[r].textContent&&n[r].classList.remove("hidden")},disabledMapFilter:function(){window.main.addMapFaded(window.card.map),window.main.addAdFormDisabled(window.filter.mapFilters),window.main.addDisabled(window.main.adFormFieldsets)}},window.backend={load:function(e,t){const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?e(n.response):t(`Статус ответа:  ${n.status} ${n.statusText}`)})),n.addEventListener("error",(function(){t("Запрос не удался")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},save:function(e,t,n){const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){200===o.status?t():n()})),o.addEventListener("timeout",(function(){n()})),o.addEventListener("error",(function(){n()})),o.timeout=1e4,o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}},(()=>{const e="\n1 комната — «для 1 гостя»;\n2 комнаты — «для 2 гостей» или «для 1 гостя»;\n3 комнаты — «для 3 гостей», «для 2 гостей» или «для 1 гостя»;\n100 комнат — «не для гостей».",t=document.querySelector("#capacity"),n=t.querySelectorAll("option");n.forEach((e=>{e.removeAttribute("disabled")})),document.querySelector("#title").setAttribute("minlength",30);const o=document.querySelector("#price");o.setAttribute("max",1e6);const r=document.querySelector("#type"),i=function(e){const t=[];return e.forEach((e=>{t.push(e.value)})),t}(r.querySelectorAll("option")),d=[0,1e3,5e3,1e4],a=function(){const e=r.value;for(let t=0;t<i.length;t++)e===i[t]&&(o.setAttribute("placeholder","от "+d[t]),o.setAttribute("min",""+d[t]))};r.addEventListener("change",a),o.setAttribute("required","required"),o.setAttribute("type","number"),o.setAttribute("max","1000000"),document.querySelector("#avatar").setAttribute("accept","image/*"),document.querySelector("#images").setAttribute("accept","image/*");const c=document.querySelector("#timein"),s=c.querySelectorAll("option"),u=document.querySelector("#timeout"),l=u.querySelectorAll("option"),f=document.querySelector(".map__pins"),m=document.querySelector(".ad-form");m.addEventListener("submit",(function(e){e.preventDefault(),window.backend.save(new FormData(m),w,g)}));const p=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),w=function(){f.appendChild(p),document.addEventListener("keydown",v),document.addEventListener("click",h),m.reset(),window.filter.mapFilters.reset(),window.main.addAdFormDisabled(m),window.main.addMapFaded(window.card.map),y(),window.main.mapPinMain.addEventListener("mousedown",window.main.onMapPinMainMousedown)},y=function(){const e=f.querySelectorAll("button");for(let t=0;t<e.length;t++)e[t].classList.contains("map__pin--main")||e[t].remove()},v=function(e){27===e.keyCode&&(p.remove(),document.removeEventListener("keydown",v),document.removeEventListener("click",h))},h=function(){p.remove(),document.removeEventListener("click",h),document.removeEventListener("keydown",v)},_=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);let L;const g=function(){document.querySelector("main").appendChild(_),L=document.querySelector(".error__button"),document.addEventListener("click",S),document.addEventListener("keydown",q),L.addEventListener("click",E)},S=function(){_.remove(),document.removeEventListener("click",S),document.removeEventListener("keydown",q),L.removeEventListener("click",E)},q=function(e){27===e.keyCode&&(_.remove(),document.removeEventListener("keydown",q),document.removeEventListener("click",S),L.removeEventListener("click",E))},E=function(){_.remove(),L.removeEventListener("click",E),document.removeEventListener("keydown",q),document.removeEventListener("click",S)},k=document.querySelector(".ad-form__reset");k.addEventListener("click",(function(){m.reset(),window.filter.mapFilters.reset(),window.main.addAdFormDisabled(m),window.main.addMapFaded(window.card.map),y(),window.main.mapPinMain.addEventListener("mousedown",window.main.onMapPinMainMousedown)})),k.addEventListener("keydown",(function(e){13===e.keyCode&&(m.reset(),window.filter.mapFilters.reset(),window.main.addAdFormDisabled(m),window.main.addMapFaded(window.card.map),y(),window.main.mapPinMain.addEventListener("mousedown",window.main.onMapPinMainMousedown))})),window.form={setTimeinAndTimeout:function(){c.addEventListener("change",(function(){for(let e=0;e<s.length;e++)s[e].value===c.value&&(u.value=c[e].value)})),u.addEventListener("change",(function(){for(let e=0;e<l.length;e++)l[e].value===u.value&&(c.value=u[e].value)}))},capacityOptions:n,capacity:t,checkRoomAndGuest:function(){const n=document.querySelector("#room_number");let o=n.value,r=t.value,i=o-1;const d=[["1"],["1","2"],["1","2","3"],["0"]];!1===(d[i].includes(o)&&d[i].includes(r))?n.setCustomValidity(e):n.setCustomValidity(""),n.addEventListener("change",(function(){const t=n.value;o=t,o>3?(o="0",i=d.length-1):i=o-1,!1===(d[i].includes(o)&&d[i].includes(r))?n.setCustomValidity(e):n.setCustomValidity("")})),t.addEventListener("change",(function(){const a=t.value;r=a,!1===(d[i].includes(o)&&d[i].includes(r))?n.setCustomValidity(e):n.setCustomValidity("")}))},onTypeChange:a}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__filters-container"),n=document.querySelector(".map");window.card={createCard:function(t){const n=e.cloneNode(!0);t.offer.title?n.querySelector(".popup__title").textContent=t.offer.title:n.querySelector(".popup__title").classList.add("hidden"),t.offer.address[0]&&t.offer.address[1]?n.querySelector(".popup__text--address").textContent=`${window.util.getFirstItemOfString(t.offer.address)} Tōkyō-to, Chiyoda-ku, Ichibanchō, ${window.util.getLastItemOfString(t.offer.address)}`:n.querySelector(".popup__text--address").classList.add("hidden"),t.offer.price?n.querySelector(".popup__text--price").textContent=t.offer.price:n.querySelector(".popup__text--price").classList.add("hidden"),t.offer.type?n.querySelector(".popup__type").textContent=t.offer.type:n.querySelector(".popup__type").classList.add("hidden"),t.offer.rooms&&t.offer.guests?n.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнатa(ы) для ${t.offer.guests} гостя(ей)`:n.querySelector(".popup__text--capacity").classList.add("hidden"),t.offer.checkin&&t.offer.checkout?n.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`:n.querySelector(".popup__text--time").classList.add("hidden");const o=n.querySelector(".popup__features").querySelectorAll("li"),r=window.util.getArrClassNameHtml(o).slice(),i=window.util.getArrOfTextBeforeDash(r);window.util.comparisonArrsAndAddClassNameHidden(t.offer.features,i,o),t.offer.description?n.querySelector(".popup__description").textContent=""+t.offer.description:n.querySelector(".popup__description").classList.add("hidden");const d=n.querySelector(".popup__photos"),a=n.querySelector(".popup__photos").querySelector("img");if(t.offer.photos){for(let e=0;e<t.offer.photos.length;e++){const n=a.cloneNode();n.src=t.offer.photos[e],n.textContent="clone",d.appendChild(n)}d.removeChild(a)}else d.classList.add("hidden");return t.author.avatar?n.querySelector(".popup__avatar").src=t.author.avatar:n.querySelector(".popup__avatar").classList.add("hidden"),n},mapFiltersContainer:t,card:e,renderCard:function(e,t){n.insertBefore(e,t)},map:n}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={pin:e,MAX_PIN:5,createPin:function(t){const n=e.cloneNode(!0);return n.querySelector("img").src=t.author.avatar,n.querySelector("img").alt=t.offer.title,n.style.left=t.location.x+"px",n.style.top=t.location.y+"px",n},onLoad}})(),(()=>{window.card.map.addEventListener("click",(function(e){let t=e.target;if("IMG"===t.tagName&&(t=t.parentNode),t.classList.contains("map__pin")&&!t.classList.contains("map__pin--main"))if(window.card.map.querySelector(".map__card"))window.card.map.removeChild(window.card.map.querySelector(".map__card"));else{const n=function(n){window.card.renderCard(window.card.createCard(n[t.dataset.index]),window.card.mapFiltersContainer);const o=document.querySelector(".popup__close"),r=window.card.map.querySelector(".map__card"),i=function(){window.card.map.removeChild(r)};o.addEventListener("click",(function(){i()})),o.addEventListener("keydown",(function(){13===e.target.code&&i()}))};window.backend.load(n,window.pin.onError)}})),window.card.map.addEventListener("keydown",(function(e){"Escape"===e.key&&window.card.map.querySelector(".map__card")&&window.card.map.removeChild(window.card.map.querySelector(".map__card"))}));const e=document.querySelector(".map__pin--main"),t=document.querySelectorAll("fieldset"),n=document.querySelector(".map__filters"),o=function(e){e.classList.add("map--faded")};o(window.card.map);const r=function(e){e.forEach((e=>{e.setAttribute("disabled","true")}))};r(t);const i=function(e){e.classList.remove("ad-form--disabled")},d=function(){t.forEach((e=>{e.removeAttribute("disabled")}))},a=document.querySelector(".ad-form"),c=function(t){1===t.which&&window.card.map.classList.remove("map--faded"),window.backend.load(window.main.onLoad,window.error.onError),i(a),d(),window.startPins.renderPin(),window.form.checkRoomAndGuest(),window.form.onTypeChange(),window.form.setTimeinAndTimeout(),e.removeEventListener("mousedown",c),e.removeEventListener("keydown",s)};window.card.map.classList.contains("map--faded")&&e.addEventListener("mousedown",c);const s=function(t){"Enter"===t.code&&window.card.map.classList.remove("map--faded"),i(a),d(),window.startPins.renderPin(),window.form.checkRoomAndGuest(),window.form.onTypeChange(),window.form.setTimeinAndTimeout(),e.removeEventListener("keydown",s),e.removeEventListener("mousedown",c)};window.card.map.classList.contains("map--faded")&&e.addEventListener("keydown",s),window.main={addMapFaded:o,addAdFormDisabled:function(e){e.classList.add("ad-form--disabled")},mapFilter:n,mapPinMain:e,onMapPinMainMousedown:c,addDisabled:r,adFormFieldsets:t}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address"),n=document.querySelector(".map__pins"),o=e.offsetHeight+22;function r(e,t,n){e.setAttribute("value",`${t}, ${n}`)}e.addEventListener("mousedown",(function(i){i.preventDefault();let d={x:i.clientX,y:i.clientY},a=Math.round(e.offsetLeft+e.offsetWidth/2),c=Math.round(e.offsetTop+o);function s(i){i.preventDefault();const s=d.x-i.clientX,u=d.y-i.clientY,l=a-s,f=c-u;a=Math.round(e.offsetLeft+e.offsetWidth/2),c=Math.round(e.offsetTop+o),d={x:i.clientX,y:i.clientY},e.style.left=e.offsetLeft-s+"px",e.style.top=e.offsetTop-u+"px",r(t,l,f),l<=0&&(e.style.left=-e.offsetWidth/2+"px",r(t,0,f)),l>=n.offsetWidth&&(e.style.left=n.offsetWidth-e.offsetWidth/2+"px",r(t,n.offsetWidth,f)),f<=130&&(e.style.top=130-o+"px",r(t,l,130)),f>=760&&(e.style.top=760-o+"px",r(t,l,760))}t.setAttribute("value",`${a}, ${c}`),document.addEventListener("mousemove",s),document.addEventListener("mouseup",(function e(t){t.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",e)}))}))})(),(()=>{const e="any",t=["wifi","dishwasher","parking","washer","elevator","conditioner"],n=1e4,o=5e4,r="any",i="middle",d="high",a=function(){const e=window.startPins.mapPinsHtml.querySelectorAll(".map__pin");for(let t=0;t<e.length;t++)e[t].classList.contains("map__pin--main")||e[t].remove()};let c;const s=document.querySelector(".map__filters");window.backend.load((function(u){const l=u;let f="any",m="any",p="any",w="any";const y=document.querySelector("#housing-type");y.addEventListener("change",(function(){a(),f=y.value}));const v=document.querySelector("#housing-price");v.addEventListener("change",(function(){a(),m=v.value}));const h=document.querySelector("#housing-rooms");h.addEventListener("change",(function(){a(),p=h.value}));const _=document.querySelector("#housing-guests");_.addEventListener("change",(function(){a(),w=_.value})),s.addEventListener("change",(function(){window.card.map.querySelector(".map__card")&&document.querySelector(".map__card").remove();const s=l.filter((function(t){return t.offer.type===f?t.offer.type===f:f===e&&t.offer.type})),u=l.filter((function(e){return m===i&&e.offer.price>=n&&e.offer.price<o?e.offer.price>=n&&e.offer.price<o:"low"===m?e.offer.price<1e4:m===d?e.offer.price>=5e4:m===r&&e.offer.price})),y=l.filter((function(t){if(p!==e){const e=parseInt(p,10);return t.offer.rooms===e}return t.offer.rooms})),v=l.filter((function(t){if(w!==e){const e=parseInt(w,10);return t.offer.guests===e}return t.offer.guests})),h=s.concat(u).concat(y).concat(v),_=h.filter((function(e,t){return h.indexOf(e)===t})).filter((function(t){if(f!==e&&t.offer.type!==f)return!1;if(m===i){if(m!==r&&t.offer.price<n)return!1;if(m!==r&&t.offer.price>=o)return!1}return!("low"===m&&m!==r&&t.offer.price>1e4||m===d&&m!==r&&t.offer.price<=5e4||p!==e&&t.offer.rooms!==parseInt(p,10)||w!==e&&t.offer.guests!==parseInt(w,10))})),L=document.querySelectorAll(".map__checkbox"),g=[];for(let e=0;e<L.length;e++)L[e].checked&&g.push(t[e]);const S=_.filter((function(e){let t=0;for(let n=0;n<g.length;n++)for(let o=0;o<e.offer.features.length;o++)g[n]===e.offer.features[o]&&t++;return t===g.length}));c&&clearTimeout(c),c=setTimeout((function(){!function(e){if(a(),e.length<window.pin.MAX_PIN)for(let t=0;t<e.length;t++){const n=window.pin.createPin(e[t]);n.setAttribute("data-index",t),window.startPins.fragment.appendChild(n),window.startPins.renderPin()}else if(e.length>window.pin.MAX_PIN)for(let t=0;t<window.pin.MAX_PIN;t++){const n=window.pin.createPin(e[t]);n.setAttribute("data-index",t),window.startPins.fragment.appendChild(n),window.startPins.renderPin()}}(S)}),500)}))}),window.error.onError),window.filter={mapFilters:s}})(),(()=>{const e=document.createDocumentFragment();const t=document.querySelector(".map__pins");window.startPins={renderPin:function(){t.appendChild(e)},dataFlats:[],fragment:e,mapPinsHtml:t}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=function(e,t,n){e.addEventListener("change",(()=>{const o=e.files[0],r=o.name.toLowerCase();if(n.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(()=>{t.src=e.result})),e.readAsDataURL(o)}}))};t(document.querySelector(".ad-form__field input[type=file]"),document.querySelector(".ad-form-header__preview img"),e);const n=document.querySelector(".ad-form__upload input[type=file]"),o=document.querySelector(".ad-form__photo"),r=document.createElement("img");r.style.width="70px",r.style.height="70px",t(n,o.appendChild(r),e)})()})();